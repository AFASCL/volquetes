# 06 — Data Model (Modelo de datos)

> Objetivo: describir el modelo Postgres (tablas clave + constraints + índices) y cómo versionamos scripts.

## 1) Convenciones de scripts SQL (sin migrador)
- Ubicación: `<carpeta scripts>`
- Naming sugerido:
  - `YYYYMMDD_<issueId>_<descripcion>.sql`
  - `YYYYMMDD_<issueId>_<descripcion>__rollback.sql`
- Cada cambio DB debe incluir:
  - Script incremental
  - Rollback manual (best-effort)

## 2) Tablas principales

### clientes

Tabla de clientes para asociar a pedidos. Solo campos definidos: nombre/razón social, teléfono, email, dirección principal, tipo (común/abono). Código interno/externo no aplica.

- **PK:** `id` (BIGSERIAL / BIGINT GENERATED BY DEFAULT AS IDENTITY)
- **Campos:**
  - `id` — BIGINT, PK
  - `nombre` — VARCHAR(255), NOT NULL (nombre o razón social)
  - `telefono` — VARCHAR(50), nullable
  - `email` — VARCHAR(255), nullable
  - `direccion_principal` — VARCHAR(500), nullable
  - `tipo` — VARCHAR(10), NOT NULL, valores: `COMUN` | `ABONO`
  - *(opcional / supuesto)* `created_at` — TIMESTAMPTZ, default now()
  - *(opcional / supuesto)* `updated_at` — TIMESTAMPTZ, default now()
- **FKs:** ninguna (pedidos referenciará clientes cuando exista el recurso pedidos).
- **Índices:**
  - `idx_clientes_nombre` — búsqueda/listado por nombre
  - `idx_clientes_tipo` — filtro por tipo (común/abono) si se usa
- **Constraints:**
  - `chk_clientes_tipo` — CHECK (tipo IN ('COMUN', 'ABONO'))
  - `nombre` NOT NULL (validación mínima: no vacío; en app también)

Scripts: incremental `YYYYMMDD_<issueId>_clientes.sql`; rollback manual `YYYYMMDD_<issueId>_clientes__rollback.sql`.

---

### volquetes

Tabla de volquetes del inventario. Identificación por código interno y código externo (QR); estado actual para listados y filtros. Estados: DISPONIBLE, EN_CLIENTE, EN_TRANSITO, FUERA_DE_SERVICIO.

- **PK:** `id` (BIGINT GENERATED BY DEFAULT AS IDENTITY)
- **Campos:**
  - `id` — BIGINT, PK
  - `codigo_interno` — VARCHAR(50), NOT NULL, UNIQUE
  - `codigo_externo` — VARCHAR(50), NOT NULL, UNIQUE
  - `estado_actual` — VARCHAR(20), NOT NULL
  - `created_at` — TIMESTAMPTZ, default now() (opcional)
  - `updated_at` — TIMESTAMPTZ, default now() (opcional)
- **FKs:** ninguna
- **Constraints:**
  - `chk_volquetes_estado_actual` — CHECK (`estado_actual` IN ('DISPONIBLE', 'EN_CLIENTE', 'EN_TRANSITO', 'FUERA_DE_SERVICIO'))
  - `uk_volquetes_codigo_interno` — UNIQUE (`codigo_interno`)
  - `uk_volquetes_codigo_externo` — UNIQUE (`codigo_externo`)
- **Índices:**
  - `idx_volquetes_estado_actual` — listado/filtro por estado
  - (UNIQUE ya crea índice sobre codigo_interno y codigo_externo; índices con nombre explícito opcionales)

Scripts: incremental `YYYYMMDD_<issueId>_volquetes.sql`; rollback manual `YYYYMMDD_<issueId>_volquetes__rollback.sql` (DROP en orden: primero `volquete_estado_historial`, luego `volquetes`).

---

### volquete_estado_historial

Registra cada cambio de estado de un volquete para auditoría y consultas. Una fila por transición.

- **PK:** `id` (BIGINT GENERATED BY DEFAULT AS IDENTITY)
- **Campos:**
  - `id` — BIGINT, PK
  - `volquete_id` — BIGINT, NOT NULL, FK → volquetes(id)
  - `estado_desde` — VARCHAR(20), NOT NULL (estado anterior)
  - `estado_hasta` — VARCHAR(20), NOT NULL (estado nuevo)
  - `fecha_hora` — TIMESTAMPTZ, NOT NULL, default now()
  - `origen` — VARCHAR(10), nullable; valores: `MANUAL`, `PEDIDO`
- **FKs:** `volquete_id` → volquetes(id); ON DELETE RESTRICT recomendado
- **Constraints:**
  - `chk_volquete_historial_estado_desde` — CHECK (`estado_desde` IN ('DISPONIBLE', 'EN_CLIENTE', 'EN_TRANSITO', 'FUERA_DE_SERVICIO'))
  - `chk_volquete_historial_estado_hasta` — CHECK (`estado_hasta` IN ('DISPONIBLE', 'EN_CLIENTE', 'EN_TRANSITO', 'FUERA_DE_SERVICIO'))
  - `chk_volquete_historial_origen` — CHECK (`origen` IS NULL OR `origen` IN ('MANUAL', 'PEDIDO'))
- **Índices:**
  - `idx_volquete_estado_historial_volquete_id` — listar historial por volquete y ordenar por fecha_hora

Scripts: creadas junto con `volquetes` en el mismo incremental; rollback en el mismo archivo __rollback (orden: historial antes que volquetes).

---

- `<tabla>`:
  - PK:
  - Campos:
  - FKs:
  - Índices:
  - Constraints:

## 3) ERD (Mermaid) — opcional pero recomendado
```mermaid
erDiagram
  EXAMPLE_USER {
    bigint id PK
    string username
    string password_hash
  }
```

## 4) Índices y performance
- Listar índices agregados y motivo (consulta que acelera).
- Evitar over-indexing.


## 5) scripts fisicamente en db/scripts/